---
title: "Description of Model Equations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{c_model_equations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Process Models and Equations

`SPoCK` assumes an annual time-step, where the following processes are applied in order:

1. Recruitment and tag releases initially occur (tag releases occur if tagging data are used),
2. Markovian movement of all individuals then occurs,
3. Total mortality, chronic tag loss (if applicable), and ageing processes then take place,

The aforementioned processes are applied to four main population partitions, which include region ($r$), year ($y$), age ($a$ and $a_+$, where the latter indicates the plus group), and sex ($s$). 

### Recruitment Processes
Recruitment processes occur at the beginning of the year and can be described by either mean recruitment or with a Beverton-Holt stock recruitment relationship. Annual recruitment generated by a mean recruitment relationship is governed by the following equation:

\begin{equation}
Rec_{r,y,s} = \mu_r^{Rec}\exp\left(\epsilon_{r,y}^{Rec}-\frac{\sigma^2_{Rec}}{2}b_y\right)\psi_s
\end{equation}

\begin{equation}
Rec_{r,y,s} = \frac{4R0_rh_rSSB_{r,y-\text{RecLag}}}{(1-h_r)SSB0_r+5(h_r-1)SSB_{r,y-\text{RecLag}}}\exp\left(\epsilon_{r,y}^{Rec}-\frac{\sigma^2_{Rec}}{2}b_y\right)\psi_s 
\end{equation}

\begin{equation}
R0_r = R0^\text{global}R0^{\text{prop}} \\
R0^{\text{prop}} = \frac{\exp(\chi_r)}{\sum_{r=1}^{n_r}\exp(\chi_r)}, \chi_{r=1} = 0
\end{equation}

\begin{equation}
h_r = 0.2 + (1 - 0.2) \frac{\exp(h^{'}_r)}{1 + \exp(h^{'}_r)}
\end{equation}

\begin{equation}
SSB_{r,y} = \sum_a^{a+} N_{r,y,a,s=1}W_{r,y,a,s=1}Mat_{r,y,a,s=1}
\end{equation}

### Population Projection

\begin{equation}
\boldsymbol{N}{_{y,a,s}} = (\boldsymbol{N}{_{y,a,s}})^T \boldsymbol{M}{_{y,a,s}}
\end{equation}

\begin{equation}
M_{k,j,y,a,s} = \frac{\exp(\omega_{k,j,y,a,s})}{\sum_{k=1}^J\exp(\omega_{k,j,y,a,s})}, \omega_{j,j,y,a,s} = 0
\end{equation}

\begin{equation}
N_{r,y+1,a+1,s} = N_{r,y,a,s}\exp(-Z_{r,y,a,s}), \quad \text{for } 1 \leq a < a_+ \\
N_{r,y+1,a,s} = N_{r,y,a-1,s}\exp(-Z_{r,y,a-1,s}) + N_{r,y,a,s}\exp(-Z_{r,y,a,s}), \quad \text{for } a = a_+
\end{equation}

\begin{equation}
Z_{r,y,a,s} = Natmort_{r,y,a,s} + \sum_{f} Fmort_{r,y,f} Sel_{r,y,a,s,f}^{Fsh}
\end{equation}

### Population Initialization

\begin{equation}
Z_{r,a,s}^{Init} = Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1}, \quad \text{for } a < a_+ \\
cumsum_{Z_{r,a,s}^{Init}} = \sum_{a=1}^{a} Z_{r,a,s}^{Init}
\end{equation}

\begin{equation}
N_{r,a,s}^{Init} = \begin{cases}
R0_r \psi_s, & \text{if } a = 1 \\
R0_r \exp\left(-cumsum_{Z_{r,a,s}^{Init}}\right)\psi_s, & \text{if } a > 1
\end{cases}
\end{equation}

\begin{equation}
N_{r,a,s}^{Init} = \begin{cases}
R0_r \exp\left(-(a-1)(Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)\psi_s, & \text{if } 2 \leq a < a_+ \\
\frac{R0_r \exp\left(-(a_+ - 1)(Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)}{1 - \exp\left(-(Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)}\psi_s, & \text{if } a = a_+
\end{cases}
\end{equation}

### Selectivity Processes (Fishery and Survey)

## Observation Models and Equations

### Fishery Observation Model

\begin{equation}
C^a_{r,y,a,s,f} = \frac{Fmort_{r,y,f}Sel^{Fsh}_{r,y,a,s,f}}{Z_{r,y,a,s}} N_{r,y,a,s} \left[1-\exp(-Z_{r,y,a,s})\right]
\end{equation}

\begin{equation}
C^l_{r,y,l,s,f} = (\boldsymbol{A}^l_{r,y,s})^T \boldsymbol{C^a}_{r,y,s,f}
\end{equation}

\begin{equation}
\text{Catch}_{r,y,f} = \sum_a^{a_+} \sum_s^{n_s} C^a_{r,y,a,s,f} W_{r,y,a,s}
\end{equation}

\begin{equation}
\text{FshIdx}_{r,y,f} = q^{Fsh}_{r,y,f} \sum_a^{a_+} \sum_s^{n_s} N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,f}^{Fsh} \\
\text{FshIdx}_{r,y,f} = q^{Fsh}_{r,y,f} \sum_a^{a_+} \sum_s^{n_s} N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,f}^{Fsh} W_{r,y,a,s}
\end{equation}

### Survey Observation Model

\begin{equation}
I^a_{r,y,a,s,sf} = N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,sf}^{Srv} \\
\end{equation}

\begin{equation}
I^l_{r,y,l,s,sf} = (\boldsymbol{A}^l_{r,y,s})^T \boldsymbol{I^a}_{r,y,s,f}
\end{equation}

\begin{equation}
\text{SrvIdx}_{r,y,sf} = q^{Srv}_{r,y,sf} \sum_a^{a_+} \sum_s^{n_s} I^a_{r,y,a,s,sf} \\ 
\text{SrvIdx}_{r,y,sf} = q^{Srv}_{r,y,sf} \sum_a^{a_+} \sum_s^{n_s} I^a_{r,y,a,s,sf} W_{r,y,a,s}
\end{equation}

### Tagging Observation Model

\begin{equation}
T^k_{r,y,a,s} = T^k_{r,y,a,s} \exp(-\tau)
\end{equation}

\begin{equation}
\boldsymbol{T}^k_{y,a,s} = (\boldsymbol{T}^k_{y,a,s})^T \boldsymbol{M}_{y,a,s}
\end{equation}

\begin{equation}
T^k_{r,y+1,a+1,s} = T^k_{r,y,a,s}\exp(-Z^{Tag}_{r,y,a,s}), \quad \text{for } 1 \leq a < a_+ \\
T^k_{r,y+1,a,s} =T^k_{r,y,a-1,s}\exp(-Z^{Tag}_{r,y,a-1,s}) + T^k_{r,y,a,s}\exp(-Z^{Tag}_{r,y,a,s}), \quad \text{for } a = a_+
\end{equation}

\begin{equation}
Z^{Tag}_{r,y,a,s} = (\kappa + NatMort^{Tag}_{r,y,a,s} + FishMort^{Tag}_{r,y,a,s})
\end{equation}

\begin{equation}
\text{Recap}^k_{r,y,a,s} = \beta_{r,y} \frac{FishMort^{Tag}_{r,y,a,s}}{Z^{Tag}_{r,y,a,s}} T^k_{r,y,a,s} \left[1-\exp(-Z^{Tag}_{r,y,a,s})\right]
\end{equation}

\begin{equation}
\beta_{r,y} = \frac{\exp(\beta^{'}_{r,y})}{1 + \exp(\beta^{'}_{r,y})}
\end{equation}

### Observation Likelihoods

#### Fishery Catches

\begin{equation}
L(log(\text{ObsCatch}_{r,y,f})) = \lambda_{\text{ObsCatch}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsCatch}}} \exp(-\frac{[log(\text{ObsCatch}_{r,y,f}) - log(\text{Catch}_{r,y,f})]^2}{2\sigma^{2^{\text{ObsCatch}}}})
\end{equation}

#### Fishery and Survey Indices

\begin{equation}
L(log(\text{ObsFshIdx}_{r,y,f})) = \lambda_{\text{ObsFshIdx}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsFshIdx}}} \exp(-\frac{[log(\text{ObsFshIdx}_{r,y,f}) - log(\text{FshIdx}_{r,y,f})]^2}{2\sigma^{2^{\text{ObsFshIdx}}}})
\end{equation}

\begin{equation}
L(log(\text{ObsSrvIdx}_{r,y,sf})) = \lambda_{\text{ObsSrvIdx}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsSrvIdx}}} \exp(-\frac{[log(\text{ObsSrvIdx}_{r,y,sf}) - log(\text{SrvIdx}_{r,y,sf})]^2}{2\sigma^{2^{\text{ObsSrvIdx}}}})
\end{equation}

#### Fishery and Survey Compositions

\begin{equation}
L((\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} * ISS * \prod_{b = 1}^{n_b} E_b^{O_b} 
\end{equation}

\begin{equation}
L(\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} * \frac{\Gamma(ISS + 1)}{\prod_b ISS * O_b + 1} \frac{\Gamma(\theta * ISS)}{\Gamma(ISS + \theta * ISS)} \prod_{b = 1}^{n_b} \frac{\Gamma(ISS * O_b + \theta * ISS * E_b)}{\theta * ISS * E_b}
\end{equation}

\begin{equation}
ESS = \frac{1}{1 + \theta} + ISS \frac{\theta}{1 + \theta}
\end{equation}

\begin{equation}
\boldsymbol{\Sigma} = \boldsymbol{I} * \frac{\theta^2} {ISS} \\
O^{'}_b = log(O_{-n_b}) - log(O_{n_b}) \\
E^{'}_b = log(E_{-n_b}) - log(E_{n_b}) \\
L(\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} * 2\pi^{-k/2} \text{det}(\boldsymbol{\Sigma})^{-1/2} \exp\left[-\frac{1}{2} (O^{'}_b - E^{'}_b)^T \boldsymbol{\Sigma}^{-1}(O^{'}_b - E^{'}_b)\right]
\end{equation}

##### Structuring Observed and Expected Compositions

#### Tagging

\begin{equation}
L(\text{ObsRecap}_{r,y,a,s}) = \frac{\exp(-\text{Recap}^k_{r,y,a,s})(\text{Recap}^k_{r,y,a,s})^{\text{ObsRecap}_{r,y,a,s}}}{\text{ObsRecap}_{r,y,a,s}!}
\end{equation}

\begin{equation}
L(\text{ObsRecap}^k_{r,y,a,s}) = \frac{\Gamma(\text{ObsRecap}_{r,y,a,s} + \eta)}{\Gamma(\eta)\Gamma(\text{ObsRecap}_{r,y,a,s} + 1)} \left(\frac{\text{Recap}_{r,y,a,s}}{\text{Recap}_{r,y,a,s} + \eta}\right)^{\text{ObsRecap}_{r,y,a,s}} \left(\frac{\eta}{\text{Recap}_{r,y,a,s}^k + \eta}\right)^\eta
\end{equation}

\begin{equation}
\text{PRecap}^k_{r,y,a,s} = \frac{\text{Recap}^k_{r,y,a,s}}{\text{InitTag}^K} \\ 
\text{PObsRecap}^k_{r,y,a,s} = \frac{\text{ObsRecap}^k_{r,y,a,s}}{\text{InitTag}^K} \\
\text{PNonRecap}^k = 1 - \sum_r \sum_y \sum_a \sum_s \text{PRecap}^k_{r,y,a,s} \\ 
\text{PObsNonRecap}^k = 1 - \sum_r \sum_y \sum_a \sum_s \text{PObsNonRecap}^k_{r,y,a,s} \\
\end{equation}


### Priors

#### Natural Mortality

\begin{equation}
P(log(NatMort_{s = 1}) = \frac{1}{\sqrt{2\pi} \sigma^{\text{NatMortPrior}}} \exp(-\frac{[log(NatMort_{s = 1}) - log(Natmort_{s = 1}^{\text{Prior}})]^2}{2\sigma^{2^{\text{NatMortPrior}}}})
\end{equation}

#### Fishery and Survey Catchability

\begin{equation}
P(log(q_{r,y,f})) = \frac{1}{\sqrt{2\pi} \sigma_{r,y,f}^{\text{qPrior}}} \exp(-\frac{[log(q_{r,y,f}) - log(q_{r,y,f}^{\text{Prior}})]^2}{2\sigma^{2^{\text{qPrior}}}_{r,y,f}})
\end{equation}

#### Steepness

\begin{equation}
a = \left(\frac{h^{\text{PriorMu}}_r - 0.2}{1 - 0.2}\right) \left(\frac{h^{\text{PriorSD}}_r }{1 - 0.2}\right)^2 \\ 
b = \left[1 - \left(\frac{h^{\text{PriorMu}}_r - 0.2}{1 - 0.2}\right)\right] \left[\left(\frac{h^{\text{PriorSD}}_r }{1 - 0.2}\right)^2\right] \\ 
P(h_r) = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)}h^{a-1}_r(1-h_r)^{b-1}
\end{equation}

#### Movement

\begin{equation}
P(M_{k,y,a,s}) = \frac{\Gamma(\sum_{j=1}^{n_r} \alpha_{j,y,a,s})}{\prod_{j=1}^{n_r}\Gamma(\alpha_{j,y,a,s})} \prod_{j=1}^{n_r}M_{k,j,y,a,s}^{\alpha_{j,y,a,s}-1}
\end{equation}

#### Tag Reporting Rates

Two types of priors can be specified for facilitating the estimation of tag reporting rates. In particular, the first type of prior includes a symmetric beta parameterization, which is given by the following:

\begin{equation}
P(\beta_{r,y}) = (\beta_{r,y} + 1e-4)^{\beta^{\text{PriorScale}} } (1 - \beta_{r,y} + 1e-4)^{\beta^{\text{PriorScale}}}
\end{equation}

where $\beta^{\text{PriorScale}}$ determines the scale of the tag reporting parameter and controls how strongly to penalize estimates when they approach the bounds of $(0,1)$. Larger values of $\beta^{\text{PriorScale}}$ result in larger penalties. By contrast, a standard beta distribution can also be specified, with shape parameters $a$ and $b$. This is given by the following expression: 

\begin{equation}
a = \frac{\beta^{\text{PriorMu}}}{\left(\beta^{\text{PriorSD}}\right)^2} \\
b = \left[\frac{1 - \beta^{\text{PriorMu}}}{\left(\beta^{\text{PriorSD}}\right)^2}\right] \\
P(\beta_{r,y}) = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)} \, \beta_{r,y}^{a-1} \left(1 - \beta_{r,y}\right)^{b-1}
\end{equation}

where $\beta^{\text{PriorMu}}$ defines the mean of the distribution, while $\beta^{\text{PriorSD}}$ defines the standard deviation of the beta distribution. Currently, only a tag reporting rate priors are not region or year-specific (i.e., the same value is applied across all regions and years). 

