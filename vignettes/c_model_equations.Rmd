---
title: "Description of Model Equations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{c_model_equations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Process Models and Equations

`SPoCK` assumes an annual time-step, where the following processes are applied in order:

1. Recruitment and tag releases initially occur (tag releases occur if tagging data are used),
2. Markovian movement of all individuals then occurs,
3. Total mortality, chronic tag loss (if applicable), and ageing processes then take place,

The aforementioned processes are applied to four main population partitions, which include region ($r$), year ($y$), age ($a$ and $a_+$, where the latter indicates the plus group), and sex ($s$). Although `SPoCK` can accommodate spatial process, all of the equations described in this vignette can collapse and be generalized to a single region (i.e., $r = 1$).

### Recruitment Processes
Recruitment processes occur at the beginning of the year and can be described by either mean recruitment or with a Beverton-Holt stock recruitment relationship. Annual recruitment generated by a mean recruitment relationship is governed by the following equation:

\begin{equation}
Rec_{r,y,s} = \mu_r^{Rec}\exp\left(\epsilon_{r,y}^{Rec}-\frac{\sigma^2_{Rec}}{2}b_y\right)\psi_s
\end{equation}

where $Rec_{r,y,s}$ represents recruitment across regions, years, and sexes. $\mu_r^{Rec}$ represents the mean recruitment parameter, $\epsilon_{r,y}^{Rec}$ are the recruitment deviations [constrained by a normal distribution](#recruitmentpen). $b_y$ represents values determined from a recruitment bias correction ramp and $\psi_s$ is the recruitment sex ratio. Recruitment parameterized as a Beverton-Holt relationship can be expressed as:

\begin{equation}
Rec_{r,y,s} = \frac{4R0_rh_rSSB_{r,y-\text{RecLag}}}{(1-h_r)SSB0_r+5(h_r-1)SSB_{r,y-\text{RecLag}}}\exp\left(\epsilon_{r,y}^{Rec}-\frac{\sigma^2_{Rec}}{2}b_y\right)\psi_s 
\end{equation}

where $R0_r$ is the virgin unfished recruitment, $h_r$ is the steepness parameter representing the fraction of $R0_r$ that would be produced when at 20% of $SSB0_r$. The steepness parameter is constrained to be between values of 0.2 and 1 and are estimated in bounded logit space:

\begin{equation}
h_r = 0.2 + (1 - 0.2) \frac{\exp(h^{'}_r)}{1 + \exp(h^{'}_r)}
\end{equation}

where $h^{'}_r$ is the steepness parameter in bounded logit space. $SSB0_r$ represents the unfished spawning stock biomass computed as the spawning biomass per recruit multiplied by $R0_r$ and $RecLag$ represents the delay between spawning and when recruits enter the population. If $RecLag > y$, the model utilizes $SSB0_r$ instead of $SSB_(r,y-RecLag)$ to compute deterministic recruitment. $SSB_(r,y)$ is the spawning stock biomass, which is computed as: 

\begin{equation}
SSB_{r,y} = \sum_a^{a+} N_{r,y,a,s=1}W_{r,y,a,s=1}Mat_{r,y,a,s=1}
\end{equation}

$N_{r,y,a,s=1}$ here represents the numbers at age across regions and years for females ($s = 1$), $W_{r,y,a,s=1}$ are values of weight at age for females, and $Mat_{r,y,a,s=1}$ are values of maturity at age. In a single-sex model, $SSB_{r,y}$ is simply computed as: $SSB_{r,y} = \sum_a^{a+} N_{r,y,a,s=1}W_{r,y,a,s=1} \cdot 0.5$. 

In a spatial model, regional mean recruitment ($\mu_r^{Rec}$) and virgin recruitment ($R0_r$) are derived using a multinomial logit transformation:
\begin{equation}
R0_r = R0^\text{global}R0^{\text{prop}} \\
R0^{\text{prop}} = \frac{\exp(\chi_r)}{\sum_{r=1}^{n_r}\exp(\chi_r)}, \chi_{r=1} = 0
\end{equation}

where $R0^\text{global}$ in this case can be either mean or virgin recruitment and represents recruitment on the population level (i.e., across all regions), while $R0^{\text{prop}}$ can similarly represent either mean or virgin recruitment and is the proportion of recruitment allocated to a given region. $\chi_r$ represents these recruitment proportions, but in multinomial logit space. 

There are also additional options that can be specified for recruitment processes in a spatial model. In particular, users can specify whether recruitment deviations are applied globally (e.g., $\mu_r^{Rec}\epsilon_{y}^{Rec}$) or locally (e.g., $\mu_r^{Rec}\epsilon_{r,y}^{Rec}$)

### Population Projection

Following recruitment processes, the population can then be projected forward. Movement processes first occur:
\begin{equation}
\boldsymbol{N}{_{y,a,s}} = (\boldsymbol{N}{_{y,a,s}})^T \boldsymbol{M}{_{y,a,s}}
\end{equation}

where $\boldsymbol{M}{_{y,a,s}}$ is a first-order Markov matrix representing movement. In a single-region case, no movement occurs (i.e., $\boldsymbol{M}{_{y,a,s}}$ is an identity matrix). Movement for a given year, age, and sex combination is constrained by a multinomial logit transformation:

\begin{equation}
M_{k,j,y,a,s} = \frac{\exp(\omega_{k,j,y,a,s})}{\sum_{k=1}^J\exp(\omega_{k,j,y,a,s})}, \omega_{j,j,y,a,s} = 0
\end{equation}

where $\omega_{k,j,y,a,s}$ are movement parameters in multinomial logit space. Given that movement parameters must sum to 1 across rows, only $n_r - 1$ movement parameters are estiamted for a given year, age, and sex combination. After the population undergoes movement, individuals then experience mortality and ageing processes following an exponential mortality model:

\begin{equation}
N_{r,y+1,a+1,s} = N_{r,y,a,s}\exp(-Z_{r,y,a,s}), \quad \text{for } 1 \leq a < a_+ \\
N_{r,y+1,a,s} = N_{r,y,a-1,s}\exp(-Z_{r,y,a-1,s}) + N_{r,y,a,s}\exp(-Z_{r,y,a,s}), \quad \text{for } a = a_+
\end{equation}

Here, $Z_{r,y,a,s}$ denotes the total instantaneous mortality:

\begin{equation}
Z_{r,y,a,s} = Natmort_{r,y,a,s} + \sum_{f} Fmort_{r,y,f} Sel_{r,y,a,s,f}^{Fsh}
\end{equation}

where $Natmort_{r,y,a,s}$ is the instantaneous natural mortality rate, $Fmort_{r,y,f}$ is the annual instantaneous fishing mortality rate and for fishery fleet $f$, and $Sel_{r,y,a,s,f}^{Fsh}$ [represents fishery selectivity processes](#selforms). $Fmort_{r,y,f}$ is determined by:

\begin{equation}
Fmort_{r,y,f} = \mu^{Fmort}_{r,f} \cdot exp(\epsilon_{r,y,f}^{FishMort})
\end{equation}

$\mu^{Fmort}_{r,f}$ are mean fishing mortality parameters for a given region and fleet, and $\epsilon_{r,y,f}^{FishMort}$ are deviations from the mean, [constrained by a normal distribution](#fishmortpen).

### Population Initialization

Several options are available for initializing the population age structure. In the first approach, the initial population age structure is derived by iterating the population to equilibrium:

\begin{equation}
Z_{r,a,s}^{Init} = Natmort_{r,1,a,s} + Fmort_{InitProp} \cdot \mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1}, \quad \text{for } a < a_+ \\
cumsum_{Z_{r,a,s}^{Init}} = \sum_{a=1}^{a} Z_{r,a,s}^{Init}
\end{equation}

$Z_{r,a,s}^{Init}$ is the initial instantaneous total mortality rate determined by the sum of natural mortality and an inital fishing mortality rate. The initial instantaneous fishing mortality rate is a user-specified value for $Fmort_{InitProp}$, which represents the proportion of $\mu_{f=1}$ to apply to the initial age structure. In `SPoCK`, it is generally recommended to structure associated data inptus for fishery fleet 1 to represent the dominant fishery fleet. $cumsum_{Z_{r,a,s}^{Init}}$ is the cumulative sum of the initial total mortality rate which is initially applied to the equilibrium age structure following an exponential motality model:

\begin{equation}
N_{r,a,s}^{Init} = \begin{cases}
R0_r \psi_s, & \text{if } a = 1 \\
R0_r \exp\left(-cumsum_{Z_{r,a,s}^{Init}}\right)\psi_s, & \text{if } a > 1
\end{cases}
\end{equation}

If mean recruitment dynamics are assumed, $R0_r$ in the above equation can simply be replaced with $\mu^{Rec}_{r}$. Following determination of the equilibrium age structure, the initial population is then iterated $n_a \cdot 5$ times where movement is first applied, followed mortality and ageing processes. In general, users might want to iterate the equilibrium age structure if movement processes occur given that there is no simple closed form solution to derive the plus-group of the population when movement occurs.

Conversely, users can also specify an initial age structure determined by a geometric series solution:

\begin{equation}
N_{r,a,s}^{Init} = \begin{cases}
R0_r \exp\left(-(a-1)(Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)\psi_s, & \text{if } 2 \leq a < a_+ \\
\frac{R0_r \exp\left(-(a_+ - 1)(Natmort_{r,1,a,s} + Fmort_{InitProp} \cdot \mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)}{1 - \exp\left(-(Natmort_{r,1,a,s} + Fmort_{init}\mu_{f=1}Sel^{Fsh}_{r,1,a,s,f=1})\right)}\psi_s, & \text{if } a = a_+
\end{cases}
\end{equation}

This approach is generally more appropriate when movement does not occur among regions, given that a closed form solution can easily be derived for the plus-group. Initial age deviations can then be applied to the equilibrium age structure:

\begin{equation}
N_{r,a,s}^{Init} = N_{r,a,s}^{Init} \exp(\epsilon_{r,y}^{Init})
\end{equation}

where $\epsilon_{r,y}^{Init}$ are initial age deviations [constrained by a normal distribution](#initpen).

### Selectivity Processes (Fishery and Survey) {#selforms}

Currently, several options are available for parameterizing fishery and survey selectivity. Two forms of logistic selectivity can be specified. The first form is:

\begin{equation}
Sel_{a} = \frac{1}{1 + \exp[-k(a - a^{50})]}
\end{equation}

where $k$ regulates the slope/steepness of the logistic curve and $a^{50}$ is the age-at-50% selection. The second logistic form is expressed as:

\begin{equation}
Sel_{a} = \frac{1}{1 + 19^{\left(\frac{a^{50} - a}{a^{95}}\right)}}
\end{equation}

Here, $a^{50}$ is the age-at-50% selection and $a^{95}$ is the age-at-95% selection. Selectivity can also be parameterized as a gamma dome-shaped function:

\begin{equation}
p = 0.5 \left[ \sqrt{(a_{s,f}^{\text{max}})^2 + 4\gamma_{s,f}^2} - a_{s,f}^{\text{max}} \right] \\
Sel_{a} = \left( \frac{a}{a_{s,f}^{\text{max}}} \right)^{\left(\frac{a_{s,f}^{\text{max}}}{p}\right)} e^{\left( \frac{a_{s,f}^{\text{max}} - a}{p} \right)}
\end{equation}

where $p$ is a derived power parameter, $\gamma$ is the shape parameter the describes the steepness of the descending limb, and $a^{max}$ is an estimated parameter describing the age-at-maximum selection. The other dome-shaped functional for availiable is the power function:

\begin{equation}
Sel_{a} = \frac{1}{a^{\phi}}
\end{equation}

$\phi$ here is a power parameter determining the descending limb (larger values are steeper)

In addition to the various functional forms that can be specified to describe selectivity processes, several parameterizations of time-varying processes can be specified. In the simplest form, time-varying selectivity can be specified as time blocks, where new selectivity parameters are estimated for an arbitrary number of user-specified periods. Several options are also available for [specifying continuous time-varying selectivity](#selpen), where deviations are restricted to vary parametrically (i.e., deviations applied to the parameters of a given selectivity form) or semi-parametrically (i.e., deviations applied about the values of a selectivity form). For example, if logistic selectivity is specified and deviations are parametric, the following expression is invoked:

\begin{equation}
Sel_{y,a} = \frac{1}{1 + \exp[-k_{y}(a - a_{y}^{50})]} \\
k_{y} = k \exp(\epsilon_{y,1}^{Sel}) \\
a_{y}^{50} = a^{50} \exp(\epsilon_{y,2}^{Sel}) 
\end{equation}

where the parameters of the logistic form are allowed to vary over time. By contrast, in the case of semi-parametric deviations for logistic selectivity, the following expression is used:

\begin{equation}
Sel_{y,a} = \frac{1}{1 + \exp[-k(a - a^{50})]} \exp(\epsilon_{y,a}^{Sel}) 
\end{equation}

where deviations are placed about the parametric form. For further details on options available, see the [selectivity process error section](#selpen).

## Observation Models and Equations

### Fishery Observation Model

\begin{equation}
C^a_{r,y,a,s,f} = \frac{Fmort_{r,y,f}Sel^{Fsh}_{r,y,a,s,f}}{Z_{r,y,a,s}} N_{r,y,a,s} \left[1-\exp(-Z_{r,y,a,s})\right]
\end{equation}

\begin{equation}
C^l_{r,y,l,s,f} = (\boldsymbol{A}^l_{r,y,s})^T \boldsymbol{C^a}_{r,y,s,f}
\end{equation}

\begin{equation}
\text{Catch}_{r,y,f} = \sum_a^{a_+} \sum_s^{n_s} C^a_{r,y,a,s,f} W_{r,y,a,s}
\end{equation}

\begin{equation}
\text{FshIdx}_{r,y,f} = q^{Fsh}_{r,y,f} \sum_a^{a_+} \sum_s^{n_s} N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,f}^{Fsh} \\
\text{FshIdx}_{r,y,f} = q^{Fsh}_{r,y,f} \sum_a^{a_+} \sum_s^{n_s} N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,f}^{Fsh} W_{r,y,a,s}
\end{equation}

### Survey Observation Model

\begin{equation}
I^a_{r,y,a,s,sf} = N_{r,y,a,s} \exp(-Z_{r,y,a,s}0.5) Sel_{r,y,a,s,sf}^{Srv} \\
\end{equation}

\begin{equation}
I^l_{r,y,l,s,sf} = (\boldsymbol{A}^l_{r,y,s})^T \boldsymbol{I^a}_{r,y,s,f}
\end{equation}

\begin{equation}
\text{SrvIdx}_{r,y,sf} = q^{Srv}_{r,y,sf} \sum_a^{a_+} \sum_s^{n_s} I^a_{r,y,a,s,sf} \\ 
\text{SrvIdx}_{r,y,sf} = q^{Srv}_{r,y,sf} \sum_a^{a_+} \sum_s^{n_s} I^a_{r,y,a,s,sf} W_{r,y,a,s}
\end{equation}

### Tagging Observation Model

\begin{equation}
T^k_{r,y,a,s} = T^k_{r,y,a,s} \exp(-\tau)
\end{equation}

\begin{equation}
\boldsymbol{T}^k_{y,a,s} = (\boldsymbol{T}^k_{y,a,s})^T \boldsymbol{M}_{y,a,s}
\end{equation}

\begin{equation}
T^k_{r,y+1,a+1,s} = T^k_{r,y,a,s}\exp(-Z^{Tag}_{r,y,a,s}), \quad \text{for } 1 \leq a < a_+ \\
T^k_{r,y+1,a,s} =T^k_{r,y,a-1,s}\exp(-Z^{Tag}_{r,y,a-1,s}) + T^k_{r,y,a,s}\exp(-Z^{Tag}_{r,y,a,s}), \quad \text{for } a = a_+
\end{equation}

\begin{equation}
Z^{Tag}_{r,y,a,s} = (\kappa + NatMort^{Tag}_{r,y,a,s} + FishMort^{Tag}_{r,y,a,s})
\end{equation}

\begin{equation}
NatMort^{Tag}_{r,y,a,s} = \frac{\sum_a\sum_s NatMort_{r,y,a,s}}{n_an_s} \\
NatMort^{Tag}_{r,y,a,s} = \frac{\sum_s NatMort_{r,y,a,s}}{n_s} \\ 
NatMort^{Tag}_{r,y,a,s} = \frac{\sum_a NatMort_{r,y,a,s}}{n_a} \\ 
NatMort^{Tag}_{r,y,a,s} = NatMort_{r,y,a,s}
\end{equation}

\begin{equation}
FishMort^{Tag}_{r,y,a,s} = Fmort_{r,y,f=1} \\
FishMort^{Tag}_{r,y,a,s} = Fmort_{r,y,f=1} \cdot \frac{\sum_s Sel_{r,y,a,s,f=1}^{Fsh}}{n_s} \\
FishMort^{Tag}_{r,y,a,s} = Fmort_{r,y,f=1} \cdot Sel_{r,y,a,s,f=1}^{Fsh} \\
FishMort^{Tag}_{r,y,a,s} = \sum_f^{n_f} Fmort_{r,y,f} \\
FishMort^{Tag}_{r,y,a,s} = \sum_{f=1} \left[Fmort_{r,y,f} \cdot \frac{\sum_s Sel_{r,y,a,s,f}^{Fsh}}{n_s} \right] \\
FishMort^{Tag}_{r,y,a,s} = \sum_{f=1} \left[Fmort_{r,y,f} \cdot Sel_{r,y,a,s,f}^{Fsh} \right] 
\end{equation}

\begin{equation}
\text{Recap}^k_{r,y,a,s} = \beta_{r,y} \frac{FishMort^{Tag}_{r,y,a,s}}{Z^{Tag}_{r,y,a,s}} T^k_{r,y,a,s} \left[1-\exp(-Z^{Tag}_{r,y,a,s})\right]
\end{equation}

\begin{equation}
\beta_{r,y} = \frac{\exp(\beta^{'}_{r,y})}{1 + \exp(\beta^{'}_{r,y})}
\end{equation}

### Observation Likelihoods

#### Fishery Catches

\begin{equation}
L(log(\text{ObsCatch}_{r,y,f})) = \lambda_{\text{ObsCatch}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsCatch}}} \exp(-\frac{[log(\text{ObsCatch}_{r,y,f}) - log(\text{Catch}_{r,y,f})]^2}{2\sigma^{2^{\text{ObsCatch}}}})
\end{equation}

\begin{equation}
L(log(\text{ObsCatch}_{y,f})) = \lambda_{\text{ObsCatch}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsCatch}}} \exp(-\frac{[log(\text{ObsCatch}_{y,f}) - log(\sum_r \text{Catch}_{r,y,f})]^2}{2\sigma^{2^{\text{ObsCatch}}}})
\end{equation}

\begin{align*}
L(\text{CensoredCatch}_{r,y,f}) = 
& \left(0.9 \cdot \phi_N\left[\frac{\log(U_{r,y,f}/\text{Catch}_{r,y,f})}{\sigma_{\text{CensoredCatch}}}\right] 
- \phi_N\left[\frac{\log(L_{r,y,f}/\text{Catch}_{r,y,f})}{\sigma_{\text{CensoredCatch}}}\right]\right) \\
& + \left(0.1 \cdot \phi_N\left[\frac{\log(U_{r,y,f}/\text{Catch}_{r,y,f})}{0.075 \cdot \sigma_{\text{CensoredCatch}}}\right] 
- \phi_N\left[\frac{\log(L_{r,y,f}/\text{Catch}_{r,y,f})}{0.075 \cdot \sigma_{\text{CensoredCatch}}}\right]\right)
\end{align*}

#### Fishery and Survey Indices

\begin{equation}
L(log(\text{ObsFshIdx}_{r,y,f})) = \lambda_{\text{ObsFshIdx}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsFshIdx}}} \exp(-\frac{[log(\text{ObsFshIdx}_{r,y,f}) - log(\text{FshIdx}_{r,y,f})]^2}{2\sigma^{2^{\text{ObsFshIdx}}}})
\end{equation}

\begin{equation}
L(log(\text{ObsSrvIdx}_{r,y,sf})) = \lambda_{\text{ObsSrvIdx}} \frac{1}{\sqrt{2\pi} \sigma^{\text{ObsSrvIdx}}} \exp(-\frac{[log(\text{ObsSrvIdx}_{r,y,sf}) - log(\text{SrvIdx}_{r,y,sf})]^2}{2\sigma^{2^{\text{ObsSrvIdx}}}})
\end{equation}

#### Fishery and Survey Compositions

\begin{equation}
L((\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} \cdot ISS \cdot \prod_{b = 1}^{n_b} E_b^{O_b} 
\end{equation}

\begin{equation}
L(\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} \cdot \frac{\Gamma(ISS + 1)}{\prod_b ISS \cdot O_b + 1} \frac{\Gamma(\theta \cdot ISS)}{\Gamma(ISS + \theta \cdot ISS)} \prod_{b = 1}^{n_b} \frac{\Gamma(ISS \cdot O_b + \theta \cdot ISS \cdot E_b)}{\theta \cdot ISS \cdot E_b}
\end{equation}

\begin{equation}
ESS = \frac{1}{1 + \theta} + ISS \frac{\theta}{1 + \theta}
\end{equation}

\begin{equation}
\boldsymbol{\Sigma} = \boldsymbol{I} \cdot \frac{\theta^2} {ISS} \\
O^{'}_b = log(O_{-n_b}) - log(O_{n_b}) \\
E^{'}_b = log(E_{-n_b}) - log(E_{n_b}) \\
L(\text{ObsCompositionData}_{r,y,f}) = \lambda_{\text{ObsCompositionData}} \cdot 2\pi^{-k/2} \text{det}(\boldsymbol{\Sigma})^{-1/2} \exp\left[-\frac{1}{2} (O^{'}_b - E^{'}_b)^T \boldsymbol{\Sigma}^{-1}(O^{'}_b - E^{'}_b)\right]
\end{equation}

##### Structuring Observed and Expected Compositions

\begin{equation}
O_b = \frac{O_b}{\sum_b O_b} \\
E_b = \frac{1}{n_s \cdot n_r} \sum_{i = 1}^{n_s \cdot n_r} \frac{E_{r,b,s}}{\sum_b E_{r,b,s}} \\
\boldsymbol{E} = \boldsymbol{E} \textbf{AgeError} \\
\boldsymbol{O} = \left\{ O_b \;\middle|\; b = 1, \ldots, n_b \right\} \\
\boldsymbol{E} = \left\{ E_b \;\middle|\; b = 1, \ldots, n_b \right\}
\end{equation}

\begin{equation}
O_{r,b,s} = \frac{O_{r,b,s}}{\sum_b O_{r,b,s}} \\
E_{r,b,s} = \frac{E_{r,b,s}}{\sum_b E_{r,b,s}} \\
\boldsymbol{E}_{r,s} = \boldsymbol{E}_{r,s} \textbf{AgeError} \\
\boldsymbol{O}_{r,s} = \left\{ O_{r,b,s} \;\middle|\; b = 1, \ldots, n_b \right\} \\
\boldsymbol{E}_{r,s} = \left\{ E_{r,b,s} \;\middle|\; b = 1, \ldots, n_b \right\} 
\end{equation}

\begin{equation}
O_{r,b,s} = \frac{O_{r,b,s}}{\sum_{b,s} O_{r,b,s}} \\
E_{r,b,s} = \frac{E_{r,b,s}}{\sum_{b,s} E_{r,b,s}} \\
\boldsymbol{E}_{r} = (\boldsymbol{E}_r)^T (\textbf{I} \otimes \textbf{AgeError}) \\
\boldsymbol{O}_r = \left\{ O_{r,b,s} \;\middle|\; b = 1,\ldots,n_b;\; s = 1,2 \right\} \\
\boldsymbol{E}_r = \left\{ E_{r,b,s} \;\middle|\; b = 1,\ldots,n_b;\; s = 1,2 \right\} 
\end{equation}

\begin{equation}
O_{r,b,s} = \frac{O_{r,b,s}}{\sum_{r,b,s} O_{r,b,s}} \\
E_{r,b,s} = \frac{E_{r,b,s}}{\sum_{r,b,s} E_{r,b,s}} \\
\boldsymbol{E} = (\boldsymbol{E})^T (\textbf{I} \otimes \textbf{AgeError}) \\
\boldsymbol{O} = \left\{ O_{r,b,s} \;\middle|\; b = 1, \ldots, n_b;\; s = 1, \ldots, n_s;\; r = 1, \ldots, n_r \right\} \\
\boldsymbol{E} = \left\{ E_{r,b,s} \;\middle|\; b = 1, \ldots, n_b;\; s = 1, \ldots, n_s;\; r = 1, \ldots, n_r \right\}
\end{equation}

#### Tagging

\begin{equation}
L(\text{ObsRecap}_{r,y,a,s}) = \frac{\exp(-\text{Recap}^k_{r,y,a,s})(\text{Recap}^k_{r,y,a,s})^{\text{ObsRecap}_{r,y,a,s}}}{\text{ObsRecap}_{r,y,a,s}!}
\end{equation}

\begin{equation}
L(\text{ObsRecap}^k_{r,y,a,s}) = \frac{\Gamma(\text{ObsRecap}_{r,y,a,s} + \eta)}{\Gamma(\eta)\Gamma(\text{ObsRecap}_{r,y,a,s} + 1)} \left(\frac{\text{Recap}_{r,y,a,s}}{\text{Recap}_{r,y,a,s} + \eta}\right)^{\text{ObsRecap}_{r,y,a,s}} \left(\frac{\eta}{\text{Recap}_{r,y,a,s}^k + \eta}\right)^\eta
\end{equation}

\begin{equation}
\text{PRecap}^k_{r,y,a,s} = \frac{\text{Recap}^k_{r,y,a,s}}{\text{InitTag}^k} \\ 
\text{PObsRecap}^k_{r,y,a,s} = \frac{\text{ObsRecap}^k_{r,y,a,s}}{\text{InitTag}^K} \\
\text{PNonRecap}^k = 1 - \sum_r \sum_y \sum_a \sum_s \text{PRecap}^k_{r,y,a,s} \\ 
\text{PObsNonRecap}^k = 1 - \sum_r \sum_y \sum_a \sum_s \text{PObsNonRecap}^k_{r,y,a,s} \\
\boldsymbol{E}^k_{\text{Tagging}} = \{\textbf{PRecap}^k, \text{PNonRecap}^k \} \\
\boldsymbol{O}^k_{\text{Tagging}} = \{\textbf{PObsRecap}^k, \text{PObsNonRecap}^k \}
\end{equation}

\begin{equation}
L(\text{ObsRecap}^k_{r,y,a,s}) = \text{InitTag}^k \prod_i (E^k_{i,\text{Tagging}})^{O^k_{i,\text{Tagging}}}
\end{equation}

\begin{equation}
\text{PRecap}^k_{r,y,a,s} = \frac{\text{Recap}^k_{r,y,a,s}}{\sum_r\sum_a\sum_s \text{Recap}^k_{r,y,a,s}} \\
\text{PObsRecap}^k_{r,y,a,s} = \frac{\text{ObsRecap}^k_{r,y,a,s}}{\sum_r\sum_a\sum_s \text{ObsRecap}^k_{r,y,a,s}} \\
\text{TotRecap}_y^k = \sum_r\sum_a\sum_s \text{ObsRecap}^k_{r,y,a,s} 
\end{equation}

\begin{equation}
L(\text{ObsRecap}^k_{r,y,a,s}) = \text{TotRecap}_y^k \prod_i (\text{PRecap}^k_{r,y,a,s})^{\text{PObsRecap}^k_{r,y,a,s}}
\end{equation}


### Priors

#### Natural Mortality

\begin{equation}
P(log(NatMort_{s = 1}) = \frac{1}{\sqrt{2\pi} \sigma^{\text{NatMortPrior}}} \exp(-\frac{[log(NatMort_{s = 1}) - log(Natmort_{s = 1}^{\text{Prior}})]^2}{2\sigma^{2^{\text{NatMortPrior}}}})
\end{equation}

#### Fishery and Survey Catchability

\begin{equation}
P(log(q_{r,y,f})) = \frac{1}{\sqrt{2\pi} \sigma_{r,y,f}^{\text{qPrior}}} \exp(-\frac{[log(q_{r,y,f}) - log(q_{r,y,f}^{\text{Prior}})]^2}{2\sigma^{2^{\text{qPrior}}}_{r,y,f}})
\end{equation}

#### Steepness

\begin{equation}
a = \left(\frac{h^{\text{PriorMu}}_r - 0.2}{1 - 0.2}\right) \left(\frac{h^{\text{PriorSD}}_r }{1 - 0.2}\right)^2 \\ 
b = \left[1 - \left(\frac{h^{\text{PriorMu}}_r - 0.2}{1 - 0.2}\right)\right] \left[\left(\frac{h^{\text{PriorSD}}_r }{1 - 0.2}\right)^2\right] \\ 
P(h_r) = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)}h^{a-1}_r(1-h_r)^{b-1}
\end{equation}

#### Movement

\begin{equation}
P(M_{k,y,a,s}) = \frac{\Gamma(\sum_{j=1}^{n_r} \alpha_{j,y,a,s})}{\prod_{j=1}^{n_r}\Gamma(\alpha_{j,y,a,s})} \prod_{j=1}^{n_r}M_{k,j,y,a,s}^{\alpha_{j,y,a,s}-1}
\end{equation}

#### Tag Reporting Rates

Two types of priors can be specified for facilitating the estimation of tag reporting rates. In particular, the first type of prior includes a symmetric beta parameterization, which is given by the following:

\begin{equation}
P(\beta_{r,y}) = (\beta_{r,y} + 1e-4)^{\beta^{\text{PriorScale}} } (1 - \beta_{r,y} + 1e-4)^{\beta^{\text{PriorScale}}}
\end{equation}

where $\beta^{\text{PriorScale}}$ determines the scale of the tag reporting parameter and controls how strongly to penalize estimates when they approach the bounds of $(0,1)$. Larger values of $\beta^{\text{PriorScale}}$ result in larger penalties. By contrast, a standard beta distribution can also be specified, with shape parameters $a$ and $b$. This is given by the following expression: 

\begin{equation}
a = \frac{\beta^{\text{PriorMu}}}{\left(\beta^{\text{PriorSD}}\right)^2} \\
b = \left[\frac{1 - \beta^{\text{PriorMu}}}{\left(\beta^{\text{PriorSD}}\right)^2}\right] \\
P(\beta_{r,y}) = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)} \, \beta_{r,y}^{a-1} \left(1 - \beta_{r,y}\right)^{b-1}
\end{equation}

where $\beta^{\text{PriorMu}}$ defines the mean of the distribution, while $\beta^{\text{PriorSD}}$ defines the standard deviation of the beta distribution. Currently, only a tag reporting rate priors are not region or year-specific (i.e., the same value is applied across all regions and years). 

### Penalties (Process Error)

#### Initial Age Deviations {#initpen}
\begin{equation}
\epsilon_{r,y}^{Init} \sim N\left(-\frac{\sigma^2_{Init}}{2},\sigma^2_{Init}\right)
\end{equation}

#### Recruitment {#recruitmentpen}
\begin{equation}
\epsilon_{r,y}^{Rec} \sim N\left(-\frac{\sigma^2_{Rec}}{2},\sigma^2_{Rec}\right)
\end{equation}

#### Fishing Mortality {#fishmortpen}
\begin{equation}
\epsilon_{r,y,f}^{Fmort} \sim N\left(0,\sigma^2_{Fmort}\right)
\end{equation}

#### Selectivity (Fishery and Survey) {#selpen}

\begin{equation}
\epsilon_{r,y,i,s,f}^{Sel} \sim N\left(0,\sigma^2_{i,Sel}\right)
\end{equation}

\begin{equation} 
\epsilon_{r,y,i,s,f}^{Sel} \sim \begin{cases}
N\left(\epsilon_{r,1,i,s,f}^{Sel}, 50^2 \right), & \text{if } i = 1 \\
N\left(\epsilon_{r,y-1,i,s,f}^{Sel},\sigma^2_{i,Sel}\right) & \text{if } i > 1
\end{cases}
\end{equation}

\begin{equation}
\boldsymbol{\epsilon}_{r,s,f}^{Sel} \sim \text{MVN}(0,\textbf{Q}) \\
\textbf{Q} = (\textbf{I} - (\textbf{B})^T) \boldsymbol{\Omega} (\textbf{I} - \textbf{B}) \\
\text{diag}(\boldsymbol{\Omega}) = \sigma_{Sel}^{-2}
\end{equation}

\begin{equation}
\mathbf{B} = \begin{bmatrix} 
1 & 0 & 0 & 0 \\
\rho_y & 0 & 0 & 0 \\
\rho_a & 0 & 0 & 0 \\
\rho_c & \rho_a & \rho_y & 0
\end{bmatrix}
\end{equation}

\begin{equation}
\boldsymbol{\epsilon}_{r,s,f}^{Sel} \sim \text{MVN}(0,\textbf{Q}^{-1}) \\
\textbf{Q} = (\textbf{I} - (\textbf{B})^T) \boldsymbol{\Omega} (\textbf{I} - \textbf{B}) \\
\end{equation}

\begin{equation}
\boldsymbol{\epsilon}_{r,s,f}^{Sel} \sim \text{MVN}(0,\textbf{Q}^{-1}) \\
\textbf{Q}^{-1} = \textbf{R}_y \otimes \textbf{R}_a \\ 
\textbf{R}_y = \begin{bmatrix} 
\rho^y_{11} & \rho^y_{12} & \rho^y_{13} \\
\rho^y_{21} & \rho^y_{22} & \rho^y_{23} \\
\rho^y_{31} & \rho^y_{32} & \rho^y_{33}
\end{bmatrix} \\

\textbf{R}_a = \begin{bmatrix} 
\rho^a_{11} & \rho^a_{12} \\
\rho^a_{21} & \rho^a_{22} \\
\end{bmatrix}
\end{equation}
