<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Run Closed Loop Simulations • SPoRC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run Closed Loop Simulations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SPoRC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Run Closed Loop Simulations</h1>
            
      

      <div class="d-none name"><code>h_closed_loop_simulations.Rmd</code></div>
    </div>

    
    
<p>In addition to being an estimation model, <code>SPoRC</code> also has
the capacity to conduct closed loop simulations to evaluate the impacts
of estimation model assumptions and harvest strategies on different
operating models. These closed loop simulations can be conducted on
either spatially-explicit or panmicitic populations. In this vignette,
we will demonstrate how a spatially-explicit closed-loop simulation by
outlining the following steps:</p>
<ol style="list-style-type: decimal">
<li>Define an operating model (the truth),</li>
<li>Define an estimation model to use in the closed-loop
simulation,</li>
<li>Setup the simulation loop to run an operating and estimation
model,</li>
<li>Derive reference points and management advice using estimates from
the estimation model, and</li>
<li>Return management advice back into the annual cycle, completing the
closed loop simulation.</li>
</ol>
<p>Let us first load in the <code>SPoRC</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chengmatt.github.io/SPoRC">SPoRC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="define-operating-model">Define Operating Model<a class="anchor" aria-label="anchor" href="#define-operating-model"></a>
</h2>
<p>We can then define an operating model we want to condition a
population on. Parameter estimates used here are purely hypothetical and
generally represents a short-lived species. Operating model simulation
can be defined with the following code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up model dimensions</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Dim.html">Setup_Sim_Dim</a></span><span class="op">(</span>n_sims <span class="op">=</span> <span class="fl">5</span>, <span class="co"># number of simulations to conduct</span></span>
<span>                          n_yrs <span class="op">=</span> <span class="fl">50</span>, <span class="co"># number of years</span></span>
<span>                          n_regions <span class="op">=</span> <span class="fl">2</span>, <span class="co"># number of regions</span></span>
<span>                          n_ages <span class="op">=</span> <span class="fl">8</span>, <span class="co"># number of ages</span></span>
<span>                          n_sexes <span class="op">=</span> <span class="fl">1</span>, <span class="co"># number of sexes</span></span>
<span>                          n_fish_fleets <span class="op">=</span> <span class="fl">1</span>, <span class="co"># number of fishery fleets</span></span>
<span>                          n_srv_fleets <span class="op">=</span> <span class="fl">1</span>, <span class="co"># number of survey fleets</span></span>
<span>                          run_feedback <span class="op">=</span> <span class="cn">T</span>, <span class="co"># specifies whether to run this as a closed-loop</span></span>
<span>                          feedback_start_yr <span class="op">=</span> <span class="fl">25</span> <span class="co"># when the closed loop starts</span></span>
<span>                          <span class="op">)</span></span></code></pre></div>
<p>We can then create a variety of simulation objects to store results
in:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up containers</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Containers.html">Setup_Sim_Containers</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">)</span></span></code></pre></div>
<p>Initial values for fishing mortality need to then be supplied. In
this case, an array <code>Fmort</code> gets populated with values
according to the specified fishing mortality patterns, and the remaining
values following <code>feedback_start_yr = 25</code> are left as zeros,
which will be populated in the closed-loop simulation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup fishing mortality</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_FishMort.html">Setup_Sim_FishMort</a></span><span class="op">(</span>sim_list <span class="op">=</span> <span class="va">sim_list</span>, <span class="co"># simulation list defined from above</span></span>
<span>                               sigmaC <span class="op">=</span> <span class="fl">1e-3</span>, <span class="co"># observation error for catch</span></span>
<span>                               init_F_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span>, <span class="co"># initial F values to impose on initial age structure</span></span>
<span>                               Fmort_pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'one-way'</span>, <span class="st">"one-way"</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span>, <span class="co"># fishing mortality pattern</span></span>
<span>                               Fmort_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span>, <span class="co"># start value of fishing mortality</span></span>
<span>                               Fmort_fct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span>, <span class="co"># factor to multiply fmort_start by to reach apicial F</span></span>
<span>                               proc_error <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># whether or not to have fishing mortality process error</span></span>
<span>                               proc_error_sd <span class="op">=</span> <span class="fl">0</span> <span class="co"># process error on fishing mortality</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Fishery selectivity dynamics can then be specified with the following
function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_FishSel.html">Setup_Sim_FishSel</a></span><span class="op">(</span>sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'logistic'</span>, <span class="st">"logistic"</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span>, <span class="co"># selex model</span></span>
<span>                              <span class="co"># a50, k for logistic shared across regions</span></span>
<span>                              fixed_fish_sel_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              sim_list <span class="op">=</span> <span class="va">sim_list</span> <span class="co"># simulation list from previous code chunk</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Similarly, survey dynamics can be defined, where a user can define
the observation error of the survey, survey catchability, and survey
selectivity:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Survey.html">Setup_Sim_Survey</a></span><span class="op">(</span>sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>                             sigmaSrvIdx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.05</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># survey observation error</span></span>
<span>                             base_srv_q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># base survey catchability value</span></span>
<span>                             srv_q_pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'constant'</span>, <span class="st">"constant"</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span>, <span class="co"># catchability pattern</span></span>
<span>                             sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'logistic'</span>, <span class="st">"logistic"</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, ncol <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span>, <span class="co"># selectivity model</span></span>
<span>                             <span class="co"># a50, k, for logistic shared across regions</span></span>
<span>                             fixed_srv_sel_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Recruitment dynamics can be defined with the code chunk below, where
various options are available, including whether recruits move, the
recruitment sex-ratio, recruitment parameters and recruitment functional
forms, as well as whether recruitment occurs globally or locally (only
applicable in a spatial context). Here, region 1 is assumed to be more
productive than region 2.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup recruitment stuff</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Rec.html">Setup_Sim_Rec</a></span><span class="op">(</span></span>
<span>  sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>  do_recruits_move <span class="op">=</span> <span class="st">"dont_move"</span>, <span class="co"># == 0, recruits don't move , == 1 recruits move</span></span>
<span>  base_rec_sexratio <span class="op">=</span> <span class="fl">1</span>, <span class="co"># single sex</span></span>
<span>  rec_sexratio_vary <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># sex ratio type</span></span>
<span>  base_r0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>  r0_vary <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># R0 type</span></span>
<span>  base_h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span>, <span class="co"># base steepness values</span></span>
<span>  init_sigmaR <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># inital deviations variability</span></span>
<span>  sigmaR <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># sigma R</span></span>
<span>  recruitment_opt <span class="op">=</span> <span class="st">"bh_rec"</span>, <span class="co"># recruitment option</span></span>
<span>  rec_dd <span class="op">=</span> <span class="st">"global"</span>, <span class="co"># recruitment deviations density dependence</span></span>
<span>  init_dd <span class="op">=</span> <span class="st">"global"</span>, <span class="co"># initial age deviations density dependence</span></span>
<span>  rec_lag <span class="op">=</span> <span class="fl">1</span> <span class="co"># recruitment ssb lag</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Biological features of the population can then be defined with the
code chunk below, with ability to define natural mortality values,
weight-at-age, maturity-at-age, and patterns for these biological
dynamics.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Biologicals.html">Setup_Sim_Biologicals</a></span><span class="op">(</span></span>
<span>  sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>  base_M_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.5</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>, <span class="co"># base M value</span></span>
<span>  M_pattern <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># M pattern</span></span>
<span>  base_WAA_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span> <span class="op">*</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span>,</span>
<span>                          dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># weight-at-age values</span></span>
<span>  base_WAA_fish_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span> <span class="op">*</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span>,</span>
<span>                             dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># weight at age fishery</span></span>
<span>  WAA_pattern <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># weight-at-age patterns</span></span>
<span>  base_Maturity_AA_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span> <span class="op">*</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span>,</span>
<span>                                  dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># matrutiy at age values</span></span>
<span>  Maturity_AA_pattern <span class="op">=</span> <span class="st">"constant"</span> <span class="co"># maturity at age patterns</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because movement dynamics can be incredibly complex, we have designed
it such that users supply their own defined movement “matrix”. This
matrix then needs to be input into the <code>sim_list</code> object for
use. Here, we are defining movement such that individuals move from the
more productive region (region 1) to the less</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">movement_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span> <span class="co"># From, To</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plug in movement process error</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">tmp_move</span> <span class="op">&lt;-</span> <span class="va">base</span><span class="op">[</span><span class="va">r</span>,<span class="op">]</span></span>
<span>          <span class="va">tmp_move</span><span class="op">[</span><span class="op">-</span><span class="va">ref</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp_move</span><span class="op">[</span><span class="op">-</span><span class="va">ref</span><span class="op">]</span></span>
<span>          <span class="va">movement_matrix</span><span class="op">[</span><span class="va">r</span>,,<span class="va">y</span>,<span class="va">a</span>,<span class="va">s</span>,<span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">tmp_move</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">tmp_move</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="co"># end r loop</span></span>
<span>      <span class="op">}</span> <span class="co"># end y loop</span></span>
<span>    <span class="op">}</span> <span class="co"># end s loop</span></span>
<span>  <span class="op">}</span> <span class="co"># end a loop</span></span>
<span><span class="op">}</span> <span class="co"># end sim loop</span></span>
<span></span>
<span><span class="va">sim_list</span><span class="op">$</span><span class="va">movement_matrix</span> <span class="op">&lt;-</span> <span class="va">movement_matrix</span></span></code></pre></div>
<p>Lastly, observation processes need to be defined for the simulation,
which includes observations for tagging data, survey indices, fishery
and survey age compositions. This is done with the following
functions:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Tagging.html">Setup_Sim_Tagging</a></span><span class="op">(</span></span>
<span>  sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>  n_tags <span class="op">=</span> <span class="fl">5000</span>, <span class="co"># number of total tags to release in a year</span></span>
<span>  max_liberty <span class="op">=</span> <span class="fl">30</span>, <span class="co"># maximum number of years to track a cohort</span></span>
<span>  tag_years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># number of years tagging occurs</span></span>
<span>  t_tagging <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># time of tagging</span></span>
<span>  base_Tag_Reporting <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span>, <span class="co"># base tag reporting rates</span></span>
<span>  Tag_Reporting_pattern <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># tag reporting rate pattern</span></span>
<span>  Tag_Ind_Mort <span class="op">=</span> <span class="fl">0</span>, <span class="co"># initial tag induced mortality</span></span>
<span>  Tag_Shed <span class="op">=</span> <span class="fl">0</span> <span class="co"># chronic tag shedding</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup observation processes</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Sim_Observation_Proc.html">Setup_Sim_Observation_Proc</a></span><span class="op">(</span></span>
<span>  sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>  Comp_Structure <span class="op">=</span> <span class="st">"spltR_jntS"</span>, <span class="co"># how compositions should be structured</span></span>
<span>  Comp_Srv_Like <span class="op">=</span> <span class="st">"Multinomial"</span>, <span class="co"># survey comp likelihood</span></span>
<span>  Comp_Fish_Like <span class="op">=</span> <span class="st">"Multinomial"</span>, <span class="co"># fishery comp likelihood</span></span>
<span>  ISS_FishAge_Pattern <span class="op">=</span> <span class="st">'constant'</span>, <span class="co"># input sample size pattern (should be constant in closed loop)</span></span>
<span>  FishAgeTheta <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># optional parameters for dirichlet-multinomial</span></span>
<span>  SrvAgeTheta <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># optional parameters for dirichlet-multinomial</span></span>
<span>  Srv_Like_Pars <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># optional parameters for dirichlet-multinomial</span></span>
<span>  base_ISS_FishAge <span class="op">=</span> <span class="fl">500</span>, <span class="co"># base sample size for fishery ages</span></span>
<span>  base_ISS_SrvAge <span class="op">=</span> <span class="fl">500</span>, <span class="co"># base sample size for survey ages</span></span>
<span>  Tag_Like <span class="op">=</span> <span class="st">"Poisson"</span>, <span class="co"># tag likelihood</span></span>
<span>  Tag_Like_Pars <span class="op">=</span> <span class="cn">NA</span> <span class="co"># tag likelihood parameters</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>All operating model specifications are now saved in
<code>sim_list</code>, which can then be later used within the
closed-loop simulation. Following the operating model specification, we
can then define what we want our estimation model to be. For
demonstration purposes, we will be directly mimicking the operating
model specification (a self-test).</p>
</div>
<div class="section level2">
<h2 id="define-estimation-model">Define Estimation Model<a class="anchor" aria-label="anchor" href="#define-estimation-model"></a>
</h2>
<p>To define the estimation model, we will be creating skeleton data,
parameter, and mapping lists using the maximum number of years in the
simulation (int this case, this is specified as 100), which will get
truncated each year up until the total number of simulation years using
the <code>Get_Feedback_Data</code> function. Note that in all the
specifications described below, almost all data objects are specified
either as 0s or NAs. These will get replaced later on, using the
<code>Get_Feedback_Data</code> function. Again, we will first set up the
general model dimensions:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize model dimensions and data list</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Dim.html">Setup_Mod_Dim</a></span><span class="op">(</span>years <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="co"># vector of years</span></span>
<span>                            ages <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_ages</span>, <span class="co"># vector of ages</span></span>
<span>                            lens <span class="op">=</span> <span class="fl">1</span>, <span class="co"># number of lengths</span></span>
<span>                            n_regions <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_regions</span>, <span class="co"># number of regions</span></span>
<span>                            n_sexes <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="co"># number of sexes</span></span>
<span>                            n_fish_fleets <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_fish_fleets</span>, <span class="co"># number of fishery fleet</span></span>
<span>                            n_srv_fleets <span class="op">=</span> <span class="va">sim_list</span><span class="op">$</span><span class="va">n_srv_fleets</span>, <span class="co"># number of survey fleets</span></span>
<span>                            verbose <span class="op">=</span> <span class="cn">F</span> <span class="co"># whether or not to return messages</span></span>
<span>                            <span class="op">)</span></span></code></pre></div>
<p>We can then setup our modeled recruitment dynamics. Here, we will be
specifying a Beverton-Holt stock recruitment function, with global
density-dependence. Moreover, we will be fixing steepness at the values
specified for the operating model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># helper to define steepness starting values</span></span>
<span><span class="va">inv_steepness</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">qlogis</a></span><span class="op">(</span><span class="op">(</span><span class="va">s</span> <span class="op">-</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup recruitment stuff (using defaults for other stuff)</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Rec.html">Setup_Mod_Rec</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>, <span class="co"># input data list from above</span></span>
<span>                            <span class="co"># Model options</span></span>
<span>                            ln_sigmaR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>, <span class="co"># sigmaR for model</span></span>
<span>                            rec_model <span class="op">=</span> <span class="st">"bh_rec"</span>, <span class="co"># recruitment model</span></span>
<span>                            sigmaR_spec <span class="op">=</span> <span class="st">"fix"</span>, <span class="co"># fix sigmaR</span></span>
<span>                            InitDevs_spec <span class="op">=</span> <span class="st">"est_shared_r"</span>, <span class="co"># estimated global initial deviations</span></span>
<span>                            RecDevs_spec <span class="op">=</span> <span class="st">"est_shared_r"</span>, <span class="co"># estimate global recruitment deviations</span></span>
<span>                            rec_dd <span class="op">=</span> <span class="st">"global"</span>, <span class="co"># global recruitment density dependence</span></span>
<span>                            rec_lag <span class="op">=</span> <span class="fl">1</span>, <span class="co"># recruitment ssb lag</span></span>
<span>                            h_spec <span class="op">=</span> <span class="st">"fix"</span>, <span class="co"># fixing steepness</span></span>
<span>                            steepness_h <span class="op">=</span> <span class="fu">inv_steepness</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="co"># steepness values in bounded logit space</span></span>
<span>                            <span class="op">)</span></span></code></pre></div>
<p>Biological values are similarly specified at the same values defined
for the operating model with the following function. Here, weight-at-age
and maturity-at-age are fixed at the true values, while natural
mortality is freely estimated.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Biologicals.html">Setup_Mod_Biologicals</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                    WAA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># weight at age </span></span>
<span>                                    MatAA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># maturity at age </span></span>
<span>                                    ln_M <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="co"># natural mortality value</span></span>
<span>                                    <span class="op">)</span></span></code></pre></div>
<p>We will also estimate movement, given that tagging data are
simulated. Movement here is specified to be constant across ages, years,
and sexes.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Movement.html">Setup_Mod_Movement</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                 <span class="co"># Model options</span></span>
<span>                                 Movement_ageblk_spec <span class="op">=</span> <span class="st">'constant'</span>, <span class="co"># constant age movement</span></span>
<span>                                 Movement_yearblk_spec <span class="op">=</span> <span class="st">'constant'</span>, <span class="co"># constant year movement</span></span>
<span>                                 Movement_sexblk_spec <span class="op">=</span> <span class="st">"constant"</span>, <span class="co"># constant sex movement</span></span>
<span>                                 do_recruits_move <span class="op">=</span> <span class="fl">0</span>, <span class="co"># recruits dont move</span></span>
<span>                                 cont_vary_movement <span class="op">=</span> <span class="st">'none'</span> <span class="co"># no continously varying movement</span></span>
<span>                                 <span class="op">)</span></span></code></pre></div>
<p>Fishery and survey data, along with associated observation processes
then need to be specified. This includes catch and composition data.
<strong>Note that for both fishery and survey composition data, an input
sample size is provided and is not left as NA or 0s</strong>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Catch_and_F.html">Setup_Mod_Catch_and_F</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                    ObsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed catches</span></span>
<span>                                    Catch_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># catch type</span></span>
<span>                                    UseCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether catch is used</span></span>
<span></span>
<span>                                    <span class="co"># Model options</span></span>
<span>                                    sigmaC_spec <span class="op">=</span> <span class="st">'fix'</span>, <span class="co"># sigma catch specification</span></span>
<span>                                    sigmaF_spec <span class="op">=</span> <span class="st">"fix"</span> <span class="co"># sigma for F specification</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup fishery indices and compositions</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_FishIdx_and_Comps.html">Setup_Mod_FishIdx_and_Comps</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                          ObsFishIdx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># fishery index (not used)</span></span>
<span>                                          ObsFishIdx_SE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># fishery index SE (not used)</span></span>
<span>                                          UseFishIdx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether fishery index is used</span></span>
<span>                                          ObsFishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed fishery age comps</span></span>
<span>                                          UseFishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether fishery ages are used</span></span>
<span>                                          ObsFishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">lens</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed fishery lengths</span></span>
<span>                                          UseFishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether fishery lengths are used</span></span>
<span>                                          ISS_FishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">500</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span><span class="co"># fishery input sample size. NOTE: This is specified at 500, as in the OM, and is not left blank!</span></span>
<span></span>
<span>                                          <span class="co"># Model options</span></span>
<span>                                          fish_idx_type <span class="op">=</span> <span class="st">"none"</span>, <span class="co"># fishery index type</span></span>
<span>                                          FishAgeComps_LikeType <span class="op">=</span> <span class="st">"Multinomial"</span>, <span class="co"># composition likelihood</span></span>
<span>                                          FishLenComps_LikeType <span class="op">=</span> <span class="st">"none"</span>, <span class="co"># composition likelihood</span></span>
<span>                                          FishAgeComps_Type <span class="op">=</span>  <span class="st">"spltRjntS_Year_1-terminal_Fleet_1"</span>, <span class="co"># age composition type</span></span>
<span>                                          FishLenComps_Type <span class="op">=</span>  <span class="st">"none_Year_1-terminal_Fleet_1"</span> <span class="co"># length composition type</span></span>
<span>                                          <span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup survey indices and compositions</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_SrvIdx_and_Comps.html">Setup_Mod_SrvIdx_and_Comps</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                         ObsSrvIdx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed survey index</span></span>
<span>                                         ObsSrvIdx_SE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.05</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed susrvey index SE</span></span>
<span>                                         UseSrvIdx <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether survey indices are used</span></span>
<span>                                         ObsSrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>,  dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># observed survey ages</span></span>
<span>                                         UseSrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether survey ages are used</span></span>
<span>                                         ObsSrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">lens</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># survey length comps</span></span>
<span>                                         UseSrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>, <span class="co"># whether survey lengths are used</span></span>
<span>                                         ISS_SrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">500</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span><span class="co"># survey input sample size. NOTE: This is specified at 500, as in the OM, and is not left blank!</span></span>
<span></span>
<span>                                         <span class="co"># Model options</span></span>
<span>                                         srv_idx_type <span class="op">=</span> <span class="st">"abd"</span>, <span class="co"># survey index type</span></span>
<span>                                         SrvAgeComps_LikeType <span class="op">=</span> <span class="st">"Multinomial"</span>, <span class="co"># composition likelihood</span></span>
<span>                                         SrvLenComps_LikeType <span class="op">=</span> <span class="st">"none"</span>, <span class="co"># composition likelihood</span></span>
<span>                                         SrvAgeComps_Type <span class="op">=</span> <span class="st">"spltRjntS_Year_1-terminal_Fleet_1"</span>, <span class="co"># age composition type</span></span>
<span>                                         SrvLenComps_Type <span class="op">=</span> <span class="st">"none_Year_1-terminal_Fleet_1"</span> <span class="co"># length composition type</span></span>
<span>                                         <span class="op">)</span></span></code></pre></div>
<p>We are almost there! We then need to specify fishery and survey
selectivity and catchability processes. In this case, a single fishery
and survey fleet operates, where selectivity is specified as logistic
for both the fishery and survey. Selectivity here is time-and
spatially-invariant. Catchability is only estimated for the survey
(since there isn’t a fishery index simulated) and is also time- and
spatially-invariant.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup fishery selectivity and catchability</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Fishsel_and_Q.html">Setup_Mod_Fishsel_and_Q</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                      <span class="co"># Model options</span></span>
<span>                                      cont_tv_fish_sel <span class="op">=</span> <span class="st">"none_Fleet_1"</span>, <span class="co"># whether selex is continously varying</span></span>
<span>                                      fish_sel_blocks <span class="op">=</span> <span class="st">"none_Fleet_1"</span>, <span class="co"># fishery selex blocks</span></span>
<span>                                      fish_sel_model <span class="op">=</span> <span class="st">"logist1_Fleet_1"</span>, <span class="co"># fishery selex model</span></span>
<span>                                      fish_q_blocks <span class="op">=</span> <span class="st">"none_Fleet_1"</span>, <span class="co"># fishery catchability blocks</span></span>
<span>                                      fish_fixed_sel_pars <span class="op">=</span> <span class="st">"est_shared_r"</span> <span class="co"># whether parameters are spatially varying</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup survey selectivity and catchability</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Srvsel_and_Q.html">Setup_Mod_Srvsel_and_Q</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                     cont_tv_srv_sel <span class="op">=</span> <span class="st">"none_Fleet_1"</span>,  <span class="co"># whether selex is continously varying</span></span>
<span>                                     srv_sel_blocks <span class="op">=</span> <span class="st">"none_Fleet_1"</span>, <span class="co"># survey selex blocks</span></span>
<span>                                     srv_sel_model <span class="op">=</span> <span class="st">"logist1_Fleet_1"</span>, <span class="co"># survey selex model</span></span>
<span>                                     srv_q_blocks <span class="op">=</span> <span class="st">"none_Fleet_1"</span>, <span class="co"># survey catchability blocks</span></span>
<span>                                     srv_fixed_sel_pars_spec <span class="op">=</span> <span class="st">"est_shared_r"</span>, <span class="co"># whether parameters are spatially varying</span></span>
<span>                                     srv_q_spec <span class="op">=</span> <span class="st">"est_shared_r"</span> <span class="co"># estimate survey q, and spatially-invariant</span></span>
<span>                                     <span class="op">)</span></span></code></pre></div>
<p>Observation processes for tagging data then need to be defined. Here,
we are assuming a Poisson tag likelihood (as in the operating model),
with constant tag reporting rates freely estimated. Note that the tag
release indicator must be defined (indicates the tag cohort (rows), by
tag region (first column), and tag release year (second column)).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup tagging stuff</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Tagging.html">Setup_Mod_Tagging</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                tag_release_indicator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">tag_rel_indicator</span><span class="op">)</span>, <span class="co"># tag release indicator (this MUST BE DEFINED!)</span></span>
<span>                                Tagged_Fish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">Tag_Fish</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">tag_rel_indicator</span><span class="op">)</span><span class="op">)</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># tagged fish</span></span>
<span>                                Obs_Tag_Recap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">Obs_Tag_Recap</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">tag_rel_indicator</span><span class="op">)</span><span class="op">)</span>,,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>, <span class="co"># tag recaptures</span></span>
<span></span>
<span>                                <span class="co"># Model options</span></span>
<span>                                UseTagging <span class="op">=</span> <span class="fl">1</span>, <span class="co"># whether tagging are used</span></span>
<span>                                t_tagging <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># time tagging occurs</span></span>
<span>                                max_tag_liberty <span class="op">=</span> <span class="fl">30</span>, <span class="co"># max tag liberty to track ohorts</span></span>
<span>                                Tag_LikeType <span class="op">=</span> <span class="st">'Poisson'</span>, <span class="co"># possion likelihood</span></span>
<span>                                tag_selex <span class="op">=</span> <span class="st">"SexSp_DomFleet"</span>, <span class="co"># sex-specific and weighted sum of fleet selex</span></span>
<span>                                tag_natmort <span class="op">=</span> <span class="st">"AgeSp_SexSp"</span>, <span class="co"># age and sex-specific natural mortailty</span></span>
<span>                                move_age_tag_pool <span class="op">=</span> <span class="st">"all"</span>, <span class="co"># pooling all tag age data to fit</span></span>
<span>                                move_sex_tag_pool <span class="op">=</span> <span class="st">"all"</span>, <span class="co"># pooling all sex data tp fit</span></span>
<span>                                Init_Tag_Mort_spec <span class="op">=</span> <span class="st">"fix"</span>, <span class="co"># don't estimate inital tag mortliaty</span></span>
<span>                                Tag_Shed_spec <span class="op">=</span> <span class="st">"fix"</span>, <span class="co"># don't estimate tag shedding</span></span>
<span>                                TagRep_spec <span class="op">=</span> <span class="st">"est_shared_r"</span>, <span class="co"># spatially-invariant tag reporting</span></span>
<span>                                Tag_Reporting_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Region_1"</span>, <span class="st">"none_Region_2"</span><span class="op">)</span> <span class="co"># no tag reporting time blocks</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Lastly, we can then set up the model weights for our estimation model
with the following function. Here, no
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
weights are used, and thus are all specified at a value of 1.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setup model weighting</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Weighting.html">Setup_Mod_Weighting</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>                                  sablefish_ADMB <span class="op">=</span> <span class="fl">0</span>, <span class="co"># not using sablefish weirdness</span></span>
<span>                                  likelihoods <span class="op">=</span> <span class="fl">1</span>, <span class="co"># tmb likelihoods</span></span>
<span>                                  Wt_Catch <span class="op">=</span> <span class="fl">1</span>, <span class="co"># catch weight</span></span>
<span>                                  Wt_FishIdx <span class="op">=</span> <span class="fl">1</span>, <span class="co"># fishery idx weight</span></span>
<span>                                  Wt_SrvIdx <span class="op">=</span> <span class="fl">1</span>, <span class="co"># survey idx weight</span></span>
<span>                                  Wt_Rec <span class="op">=</span> <span class="fl">1</span>, <span class="co"># recruitment penatly weight</span></span>
<span>                                  Wt_F <span class="op">=</span> <span class="fl">1</span>, <span class="co"># fishing mortality weight</span></span>
<span>                                  Wt_Tagging <span class="op">=</span> <span class="fl">1</span>, <span class="co"># tagging weight</span></span>
<span>                                  </span>
<span>                                  <span class="co"># composition data weights</span></span>
<span>                                  Wt_FishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                  Wt_FishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                  Wt_SrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                  Wt_SrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, we can create skeleton data, parameters, and mapping lists,
which define our estimationg model. The dimensions of these lists will
get adjusted, which will get adjusted later on.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">skeleton_data</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">skeleton_parameters</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="va">skeleton_mapping</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">map</span></span></code></pre></div>
<p>After defining the operating and estimation model, we can now setup
our closed-loop simulation. The closed-loop simulation requires a
harvest control rule to be defined by the user. In this case, we are
using a threshold control rule, but any type of rule can be defined.
Note that the harvest control rule defined must be a function that has
the arguments <code>x</code> which takes spawning biomass as an input,
<code>frp</code>, which takes a fishery reference point, and
<code>brp</code>, which takes a biological reference point. Any
additional arguments should be specified with defaults if they are to be
used.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HCR_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">frp</span>, <span class="va">brp</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stock_status</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="va">brp</span> <span class="co"># define stock status</span></span>
<span>  <span class="co"># If stock status is &gt; 1</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span></span>
<span>  <span class="co"># If stock status is between brp and alpha</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;</span> <span class="va">alpha</span> <span class="op">&amp;&amp;</span> <span class="va">stock_status</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span> <span class="op">*</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="co"># If stock status is less than alpha</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then setup a simulation environment (external from the global)
that can be used to store all simulation outputs with the
<code>Setup_sim_env</code> function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_sim_env.html">Setup_sim_env</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-closed-loop">Run Closed Loop<a class="anchor" aria-label="anchor" href="#run-closed-loop"></a>
</h2>
<p>Our closed loop can then be defined with the following code chunk.
The first loop characterizes a given simulation, while the second loop
characterizes the a given year and simulation. The
<code>run_annual_cycle</code> function is then utilized to run
population dynamics for a given year. Following that, if we are in a
year where we want to begin management feedback, we first obtain the
necessary data from years <code>1:y</code> for a given simulation using
the function <code>Get_Feedback_Data</code>, which truncates the
skeleton data, parameters, and mapping list to the correct years. We
then feed these lists to the estimation model using the
<code>fit_model</code> function. Next, we will extract the necessary
inputs into the reference point functions and projection functions.
Reference points can then derived using
<code>Get_Reference_Points</code> and the associated catch from said
reference point is then derived using a 1 year population projection
using the <code>Do_Population_Projection</code> function. Lastly, the
catch associated with the reference point is then input back into the
simulated population. This is then by converting the estimated catch to
fishing mortality rates using the <code>bisection_F</code> function,
which is based on the true underlying population dynamics simulated from
the operating model.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># to reproduce</span></span>
<span><span class="co"># Start Simulation</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co">### Run Annual Cycle --------------------------------------------------------</span></span>
<span>    <span class="fu"><a href="../reference/run_annual_cycle.html">run_annual_cycle</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">sim</span>, <span class="va">sim_env</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Start Feedback Loop</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">feedback_start_yr</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="co"># Get feedback data (aligning year index)</span></span>
<span>      <span class="va">feedback</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Get_Feedback_Data.html">Get_Feedback_Data</a></span><span class="op">(</span>sim_env <span class="op">=</span> <span class="va">sim_env</span>, sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>                                    y <span class="op">=</span> <span class="va">y</span>, sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>                                    skeleton_data <span class="op">=</span> <span class="va">skeleton_data</span>,</span>
<span>                                    skeleton_parameters <span class="op">=</span> <span class="va">skeleton_parameters</span>,</span>
<span>                                    skeleton_mapping <span class="op">=</span> <span class="va">skeleton_mapping</span></span>
<span>                                    <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Extract out data, parameters, and mapping</span></span>
<span>      <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">feedback</span><span class="op">$</span><span class="va">retro_data</span></span>
<span>      <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">feedback</span><span class="op">$</span><span class="va">retro_parameters</span></span>
<span>      <span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">feedback</span><span class="op">$</span><span class="va">retro_mapping</span></span>
<span></span>
<span>      <span class="co">### Run Assessment ----------------------------------------------------------</span></span>
<span>      <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>                       <span class="va">parameters</span>,</span>
<span>                       <span class="va">mapping</span>,</span>
<span>                       random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       newton_loops <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                       silent <span class="op">=</span> <span class="cn">T</span></span>
<span>                       <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Get necessary data inputs for later functions</span></span>
<span>      <span class="va">n_proj_yrs</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>      <span class="va">tmp_terminal_NAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal numbers at age</span></span>
<span>      <span class="va">tmp_WAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age spawning</span></span>
<span>      <span class="va">tmp_WAA_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">WAA_fish</span><span class="op">[</span>,<span class="va">y</span>,,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age fishery</span></span>
<span>      <span class="va">tmp_MatAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">MatAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># maturity at age</span></span>
<span>      <span class="va">tmp_fish_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span>,<span class="va">y</span>,,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># selectivity</span></span>
<span>      <span class="va">tmp_Movement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Movement</span><span class="op">[</span>,,<span class="va">y</span>,,,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>, <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">tmp_terminal_F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>,<span class="va">y</span>,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal fishing mortality</span></span>
<span>      <span class="va">tmp_natmort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># natural mortality</span></span>
<span>      <span class="va">tmp_recruitment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># recruitment to use for projections</span></span>
<span></span>
<span>      <span class="co">### Run reference point module ----------------------------------------------</span></span>
<span>      <span class="va">reference_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Get_Reference_Points.html">Get_Reference_Points</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                                               rep <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                                               SPR_x <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>                                               t_spwn <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                               sex_ratio_f <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                                               calc_rec_st_yr <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                               rec_age <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                               type <span class="op">=</span> <span class="st">'multi_region'</span>,</span>
<span>                                               what <span class="op">=</span> <span class="st">'independent_SPR'</span></span>
<span>                                               <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># extract fishery and biological reference points</span></span>
<span>      <span class="va">tmp_f_ref_pt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">reference_points</span><span class="op">$</span><span class="va">f_ref_pt</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span> <span class="co"># fishery reference points</span></span>
<span>      <span class="va">tmp_b_ref_pt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">reference_points</span><span class="op">$</span><span class="va">b_ref_pt</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span> <span class="co"># biological reference points</span></span>
<span></span>
<span>     <span class="co">### Run Projection Module ---------------------------------------------------</span></span>
<span></span>
<span>     <span class="co"># Do projection to get TAC</span></span>
<span>     <span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Do_Population_Projection.html">Do_Population_Projection</a></span><span class="op">(</span>n_proj_yrs <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                      n_regions <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>                                      n_ages <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>,</span>
<span>                                      n_sexes <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>                                      sexratio <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                      n_fish_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span>,</span>
<span>                                      do_recruits_move <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                      recruitment <span class="op">=</span> <span class="va">tmp_recruitment</span>,</span>
<span>                                      terminal_NAA <span class="op">=</span> <span class="va">tmp_terminal_NAA</span>,</span>
<span>                                      terminal_F <span class="op">=</span> <span class="va">tmp_terminal_F</span>,</span>
<span>                                      natmort <span class="op">=</span> <span class="va">tmp_natmort</span>,</span>
<span>                                      WAA <span class="op">=</span> <span class="va">tmp_WAA</span>,</span>
<span>                                      WAA_fish <span class="op">=</span> <span class="va">tmp_WAA_fish</span>,</span>
<span>                                      MatAA <span class="op">=</span> <span class="va">tmp_MatAA</span>,</span>
<span>                                      fish_sel <span class="op">=</span> <span class="va">tmp_fish_sel</span>,</span>
<span>                                      Movement <span class="op">=</span> <span class="va">tmp_Movement</span>,</span>
<span>                                      f_ref_pt <span class="op">=</span> <span class="va">tmp_f_ref_pt</span>,</span>
<span>                                      b_ref_pt <span class="op">=</span> <span class="va">tmp_b_ref_pt</span>,</span>
<span>                                      HCR_function <span class="op">=</span> <span class="va">HCR_function</span>,</span>
<span>                                      recruitment_opt <span class="op">=</span> <span class="st">"mean_rec"</span>,</span>
<span>                                      fmort_opt <span class="op">=</span> <span class="st">"HCR"</span>,</span>
<span>                                      t_spawn <span class="op">=</span> <span class="fl">0</span></span>
<span>                                      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Get TAC</span></span>
<span>      <span class="va">tmp_TAC</span> <span class="op">&lt;-</span> <span class="va">proj</span><span class="op">$</span><span class="va">proj_Catch</span><span class="op">[</span>,<span class="fl">2</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="co"># get TAC from projected year</span></span>
<span></span>
<span>      <span class="co">### TAC to Fishing Mortality ------------------------------------------------</span></span>
<span>      <span class="co"># Only run till last year</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw">for</span><span class="op">(</span><span class="va">f</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>            <span class="co"># Go from TAC to Fishing mortality (using true values from simulation)</span></span>
<span>            <span class="va">tmp_F</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bisection_F.html">bisection_F</a></span><span class="op">(</span>f_guess <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                                 catch <span class="op">=</span> <span class="va">tmp_TAC</span><span class="op">[</span><span class="va">r</span>,<span class="fl">1</span>,<span class="va">f</span><span class="op">]</span>,</span>
<span>                                 NAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span><span class="va">r</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,,,<span class="va">sim</span><span class="op">]</span>,</span>
<span>                                 WAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span><span class="va">r</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,,,<span class="va">sim</span><span class="op">]</span>, </span>
<span>                                 natmort <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">M</span><span class="op">[</span><span class="va">r</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,,,<span class="va">sim</span><span class="op">]</span>,</span>
<span>                                 fish_sel <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span><span class="va">r</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,,,<span class="va">f</span>,<span class="va">sim</span><span class="op">]</span></span>
<span>                                 <span class="op">)</span></span>
<span></span>
<span>            <span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span><span class="va">r</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,<span class="va">f</span>,<span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp_F</span></span>
<span></span>
<span>          <span class="op">}</span> <span class="co"># end r loop</span></span>
<span>        <span class="op">}</span> <span class="co"># end f loop</span></span>
<span>      <span class="op">}</span> <span class="co"># end if</span></span>
<span></span>
<span>    <span class="op">}</span> <span class="co"># end if for feedback loop</span></span>
<span></span>
<span>  <span class="op">}</span> <span class="co"># end y loop</span></span>
<span><span class="op">}</span> <span class="co"># end sim loop</span></span></code></pre></div>
<p>We can then inspect some outputs from the MSE. Plotted below are
trajectories of regional fishing mortality and spawning stock biomass
for a given simulation. The dotted vertical line indicates when the
feedback loop first started.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trajectories of spawning biomass</span></span>
<span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Sim <span class="op">=</span> <span class="va">Var3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">Sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">feedback_start_yr</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Region</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'SSB'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Trajectories of observed catches</span></span>
<span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">Obs_Catch</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Fleet <span class="op">=</span> <span class="va">Var3</span>, Sim <span class="op">=</span> <span class="va">Var4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">!=</span> <span class="fl">36</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">Sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">feedback_start_yr</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Region</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Catch'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/h_ssb_closed_loop.png"><img src="figures/h_catch_closed_loop.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Cheng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
